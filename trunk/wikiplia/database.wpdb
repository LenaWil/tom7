WPDB
7
b%3Acompile 2 51/(##CLOSURE## () "s" (parse (xcase s 'no '(h _ h))))

b%3Acompile.b 1 115/";; b \"compiler\" is trivial -- it's just the built-in XESP parser\n(lambda 's '(parse (xcase s 'no '(h _ h))))\n"

main 7 4831/(let 'nil '() '(let 'car (lambda 'args '(xcase args 'noa '(arg u (xcase arg 'error_car_nil '(h u h))))) '(let 'cdr (lambda 'args '(xcase args 'nob '(arg u (xcase arg 'error_cdr_nil '(u t t))))) '(let 'stdheader "Content-Type: text/html; charset=utf-8\r\n\r\n" '(let 'stdpage "<html><head><link rel=stylesheet type=\"text/css\" href=\"/raw/_/polybook.css\" title=\"polybook\"/></head><body>\n" '(let 'redirect (lambda 'target '(string "Location: " (car target) "\r\n\r\n")) '(let 'map (lambda 'args '(let 'self (car args) '(let 'f (car (cdr args)) '(let 'l (car (cdr (cdr args))) '(if l '(cons (f (car l)) (self self f (cdr l))) 'nil))))) '(let 'token (lambda 'args '(let 'self (car args) '(let 'sep (car (cdr args)) '(let 's (car (cdr (cdr args))) '(let 'n (car (cdr (cdr (cdr args)))) '(if (eq n (size s)) '(list s "") '(let 'ch (sub s n) '(if (eq ch sep) '(list (substr s 0 n) (substr s (+ n 1) (- (size s) (+ n 1)))) '(self self sep s (+ n 1)))))))))) '(let 'rtoken (lambda 'args '(let 'self (car args) '(let 'sep (car (cdr args)) '(let 's (car (cdr (cdr args))) '(let 'n (car (cdr (cdr (cdr args)))) '(if (eq n (- 0 1)) '(list "" s) '(let 'ch (sub s n) '(if (eq ch sep) '(list (substr s 0 n) (substr s (+ n 1) (- (size s) (+ n 1)))) '(self self sep s (- n 1)))))))))) '(let 'htmlescape (lambda 'hargs '(let 's (car hargs) '(let 'hrec (lambda 'args '(let 'self (car args) '(let 'n (car (cdr args)) '(if (eq n (size s)) 'nil '(let 'ch (sub s n) '(cons (if (eq ch "<") '"&lt;" '(if (eq ch ">") '"&gt;" '(if (eq ch "&") '"&amp;" 'ch))) (self self (+ n 1)))))))) '(eval (cons string (hrec hrec 0)))))) '(let 'url (car (cdr (token token "/" request.url 0))) '(let 'action_target (token token "/" url 0) '(let 'action (car action_target) '(let 'fulltarget (car (cdr action_target)) '(let 'tabs (lambda 'args '(let 'page (car args) '(string "<div class=\"tabs\">" "<span class=\"tab\"><a href=\"/view/_/" page "\">view</a></span> " "<span class=\"tab\"><a href=\"/edit/" page "\">edit</a></span> " "<span class=\"tab\"><a href=\"/history/" page "\">history</a></span> " "<span class=\"tab\"><a href=\"/run/" page "\">run</a></span> " "</div>"))) '(if (eq action "edit") '(let 'oldcontents (handle '(head fulltarget) '(_ nil)) '(string stdheader stdpage (tabs fulltarget) "<p>" (if oldcontents '(string "editing " fulltarget " ... ") '(string "creating new page " fulltarget " ... ")) "<br/><b>Do not copy text from other websites without permission. It will be deleted.</b>" "<form method=\"post\" action=\"/save/" fulltarget "\"><textarea rows=35 cols=120 name=\"contents\">" (xcase oldcontents '"" '(_ _ "(was list data)") '(_ "(was quoted data)") '(htmlescape oldcontents) '(string "(was int " oldcontents ")") '(_ "(was symbol)") '"(internal data)") "</textarea>\n" "<input type=submit value=\"save\"></form>")) '(if (eq action "save") '(let 'base_ext (rtoken rtoken "." fulltarget (- (size fulltarget) 1)) '(let 'base (car base_ext) '(let 'ext (car (cdr base_ext)) '(let 'dat form.contents '(if (eq base "") '(let '_ (insert fulltarget dat) '(redirect (string "/view/_/" fulltarget))) '(let 'compile (handle '(eval (head (string ext ":compile"))) '(_ nil)) '(let '_ (insert fulltarget dat) '(if compile '(let 'exe (handle '(compile dat) '(msg (list 'abort (string "compilation of " fulltarget " failed because " msg)))) '(let '_ (insert base exe) '(redirect (string "/view/_/" fulltarget)))) '(redirect (string "/view/_/" fulltarget)))))))))) '(if (eq action "history") '(string stdheader stdpage (tabs fulltarget) "<p>history for " fulltarget " ...<hr/><p>" (string (map map (lambda 'args '(string "<a href=\"/view/" (car args) "/" fulltarget "\">" (car args) "</a> ")) (history fulltarget)))) '(if (eq action "view") '(let 'rev_target (token token "/" fulltarget 0) '(let 'rev (car rev_target) '(let 'target (car (cdr rev_target)) '(string stdheader stdpage (tabs target) "<p>viewing " target (if (eq rev "_") '"" '(string " @ " rev)) " ... <hr/><p>" (handle '(string "<pre>\n" (htmlescape (if (eq rev "_") '(head target) '(read target (int rev)))) "</pre>\n") '(_ (string "There is no symbol called <b>" target "</b>. " "Perhaps you'd like to <a href=\"/edit/" target "\">create it</a>?"))))))) '(if (eq action "raw") '(let 'rev_target (token token "/" fulltarget 0) '(let 'rev (car rev_target) '(let 'target (car (cdr rev_target)) '(string stdheader (if (eq rev "_") '(head target) '(read target (int rev))))))) '(if (eq action "run") '(string stdheader stdpage (tabs fulltarget) "<p>running " fulltarget " ... <hr/><p>" (handle '(let 'prog (head fulltarget) '(handle '(eval prog) '(msg (string "<b>Runtime error</b>: " msg)))) '(_ (string "There is no symbol called <b>" fulltarget "</b>. " "Perhaps you'd like to <a href=\"/edit/" fulltarget "\">create it</a>?")))) '(string stdheader "unknown action!"))))))))))))))))))))))
!4=X

main.b 6 9786/";;                                 -*- lisp -*-\n; This is the initial (bootstrapping) program.\n; its role is to provide a minimal wiki interface\n; that will allow us to develop compilers for\n; better languages, that we can then use to\n; overwrite this program.\n\n(let 'nil '() '\n(let 'car (lambda 'args\n            '(xcase args 'noa '(arg u\n                                   (xcase arg 'error_car_nil '(h u h))))) '\n(let 'cdr (lambda 'args\n            '(xcase args 'nob '(arg u \n                                   (xcase arg 'error_cdr_nil '(u t t))))) '\n(let 'stdheader \"Content-Type: text/html; charset=utf-8\\r\\n\\r\\n\" '\n(let 'stdpage \"<html><head><link rel=stylesheet type=\\\"text/css\\\" href=\\\"/raw/_/polybook.css\\\" title=\\\"polybook\\\"/></head><body>\\n\" '\n(let 'redirect (lambda 'target '(string \"Location: \" (car target) \"\\r\\n\\r\\n\")) '\n\n\n(let 'map \n  (lambda 'args\n    '(let 'self (car args)\n          '(let 'f (car (cdr args))\n                '(let 'l (car (cdr (cdr args)))\n                      '(if l\n                           '(cons (f (car l)) (self self f (cdr l)))\n                         'nil))))) '\n\n; chop up to the first instance of the char given\n(let 'token\n  (lambda 'args\n    '(let 'self (car args)\n          '(let 'sep (car (cdr args))\n                '(let 's (car (cdr (cdr args)))\n                      '(let 'n (car (cdr (cdr (cdr args))))\n                            '(if (eq n (size s)) '(list s \"\")\n                               '(let 'ch (sub s n)\n                                     '(if (eq ch sep)\n                                          '(list (substr s 0 n) (substr s (+ n 1) (- (size s) (+ n 1))))\n                                          '(self self sep s (+ n 1)))\n                                     ))))))) '\n\n; same, but last instance                     \n(let 'rtoken\n  (lambda 'args\n    '(let 'self (car args)\n          '(let 'sep (car (cdr args))\n                '(let 's (car (cdr (cdr args)))\n                      '(let 'n (car (cdr (cdr (cdr args))))\n                            '(if (eq n (- 0 1)) '(list \"\" s)\n                               '(let 'ch (sub s n)\n                                     '(if (eq ch sep)\n                                          '(list (substr s 0 n) (substr s (+ n 1) (- (size s) (+ n 1))))\n                                          '(self self sep s (- n 1)))\n                                     ))))))) '\n\n(let 'htmlescape\n  ; PERF\n  (lambda 'hargs\n    '(let 's (car hargs)\n         '(let 'hrec (lambda 'args\n                       '(let 'self (car args)\n                             '(let 'n (car (cdr args))\n                                   '(if (eq n (size s))\n                                        'nil\n                                      '(let 'ch (sub s n)\n                                            '(cons\n                                              (if (eq ch \"<\")\n                                                  '\"&lt;\"\n                                                '(if (eq ch \">\")\n                                                     '\"&gt;\"\n                                                   '(if (eq ch \"&\")\n                                                        '\"&amp;\"\n                                                      'ch)))\n                                              (self self (+ n 1))))))))\n               '(eval (cons string (hrec hrec 0)))))) '\n\n  ; figure out what we're doing based on the URL\n  ; (toss off the starting / char)\n(let 'url (car (cdr (token token \"/\" request.url 0))) '\n(let 'action_target (token token \"/\" url 0) '\n(let 'action (car action_target) '\n(let 'fulltarget (car (cdr action_target)) '\n  \n(let 'tabs (lambda 'args\n             '(let 'page (car args) '\n                   ; XXX make tabs\n                   (string \"<div class=\\\"tabs\\\">\"\n                           \"<span class=\\\"tab\\\"><a href=\\\"/view/_/\" page \"\\\">view</a></span> \"\n                           \"<span class=\\\"tab\\\"><a href=\\\"/edit/\" page \"\\\">edit</a></span> \"\n                           \"<span class=\\\"tab\\\"><a href=\\\"/history/\" page \"\\\">history</a></span> \"\n                           \"<span class=\\\"tab\\\"><a href=\\\"/run/\" page \"\\\">run</a></span> \"\n                           \"</div>\"))) '\n\n  (if (eq action \"edit\")\n      ;; need to fetch the source code for this page\n      ;; and put it in the textarea\n      '(let 'oldcontents (handle '(head fulltarget) '(_ nil)) '\n        (string stdheader stdpage\n                (tabs fulltarget) \"<p>\"\n               (if oldcontents\n                   '(string \"editing \" fulltarget \" ... \")\n                   '(string \"creating new page \" fulltarget \" ... \"))\n               \"<br/><b>Do not copy text from other websites without permission. It will be deleted.</b>\"\n               \"<form method=\\\"post\\\" action=\\\"/save/\" fulltarget \"\\\"><textarea rows=35 cols=120 name=\\\"contents\\\">\"\n               (xcase oldcontents\n                   '\"\"\n                   '(_ _ \"(was list data)\")\n                   '(_ \"(was quoted data)\")\n                   '(htmlescape oldcontents)\n                   '(string \"(was int \" oldcontents \")\")\n                   '(_ \"(was symbol)\")\n                   '\"(internal data)\")\n               \"</textarea>\\n\"\n               \"<input type=submit value=\\\"save\\\"></form>\"))\n\n    '(if (eq action \"save\")\n       ; might need to compile... \n       ; figure out the language based on the extension.\n      '(let 'base_ext (rtoken rtoken \".\" fulltarget (- (size fulltarget) 1)) '\n       (let 'base (car base_ext) '\n       (let 'ext (car (cdr base_ext)) '\n       (let 'dat form.contents '\n\n       (if (eq base \"\")\n           ;; if there was no . then ext holds the entire name. in this case\n           ;; just save.\n           '(let '_ (insert fulltarget dat) '\n                 ;; XXX goto revision\n                 (redirect (string \"/view/_/\" fulltarget)))\n\n         ;; otherwise we should compile, saving the source and compiled version\n         ;; (might do this recursively??  eg. prog.b.w)\n         ; get (and run to produce a closure) the compiler, if any\n         '(let 'compile (handle '(eval (head (string ext \":compile\"))) '(_ nil)) '\n            ; save source\n            (let '_ (insert fulltarget dat) '\n             (if compile\n               '(let 'exe (handle '(compile dat) '(msg\n                                                  ; if compilation fails, then we\n                                                  ; return a program that aborts\n                                                  (list\n                                                   'abort\n                                                   (string\n                                                    \"compilation of \" fulltarget\n                                                    \" failed because \" msg)))) '\n               ; save executable\n               (let '_ (insert base exe) '\n                    ;; XXX should jump directly to the revision we inserted\n                    (redirect (string \"/view/_/\" fulltarget))\n                    )) ; compiler exists\n              '(redirect (string \"/view/_/\" fulltarget)))\n        ))))))) ; action save\n\n       '(if (eq action \"history\")\n            '(string\n              stdheader stdpage\n              (tabs fulltarget)\n              \"<p>history for \" fulltarget \" ...<hr/><p>\"\n              (string (map map (lambda 'args '(string \"<a href=\\\"/view/\" (car args) \"/\" fulltarget \"\\\">\" \n                                                      (car args) \"</a> \")) (history fulltarget))))\n\n       '(if (eq action \"view\")\n           '(let 'rev_target (token token \"/\" fulltarget 0) '\n            (let 'rev (car rev_target) '\n            (let 'target (car (cdr rev_target)) '     \n             (string\n              stdheader stdpage\n              (tabs target)\n              \"<p>viewing \" target (if (eq rev \"_\") '\"\" '(string \" @ \" rev)) \" ... <hr/><p>\"\n              (handle '(string \"<pre>\\n\" (htmlescape (if (eq rev \"_\") '(head target) '(read target (int rev)))) \"</pre>\\n\")\n                      '(_\n                        (string \"There is no symbol called <b>\" target \"</b>. \"\n                                \"Perhaps you'd like to <a href=\\\"/edit/\" target \"\\\">create it</a>?\")))))))\n\n       ;; like view, but no excess stuff/escaping (good for including CSS, for instance)\n       '(if (eq action \"raw\")\n           '(let 'rev_target (token token \"/\" fulltarget 0) '\n            (let 'rev (car rev_target) '\n            (let 'target (car (cdr rev_target)) '     \n             (string\n              stdheader (if (eq rev \"_\") '(head target) '(read target (int rev))) )\n             )))\n\n          ;; XXX protect against run main...? (= infinite loop)\n         '(if (eq action \"run\")\n            '(string\n              stdheader stdpage\n              (tabs fulltarget)\n              \"<p>running \" fulltarget \" ... <hr/><p>\"\n              (handle '(let 'prog (head fulltarget)\n                          '(handle '(eval prog) '(msg (string \"<b>Runtime error</b>: \" msg))))\n                      '(_\n                        (string \"There is no symbol called <b>\" fulltarget \"</b>. \"\n                                \"Perhaps you'd like to <a href=\\\"/edit/\" fulltarget \"\\\">create it</a>?\"))))\n            \n\n          '(string stdheader \"unknown action!\")))\n\n       )))) ; action case analysis\n\n)))))))))))))))\n"
!3=M708:10/char\n(letX

polybook.css 5 480/"       .tabs { border-bottom : 1px solid #000000 ; }\n       .tab { font : 11px Verdana,Arial,Helvetica ; padding : 2px 4px 4px 2px ; margin-right : 4px ; border-top : 1px solid #000000 ; border-left : 1px solid #000000 ; border-right : 1px solid #000000 ; }\n\n       A:link { color: #4444DD }\n       A:visited { color: #9999FF }\n       A:active { color: #DDDD44 }\n\n       BODY { font : 12px Verdana,Arial,Helvetica ; }\n       P { font : 12px Verdana,Arial,Helvetica ; }\n"

